# Liquid in a Nomad cluster

Use the instructions in [the cluster repository](https://github.com/liquidinvestigations/cluster) to get a working setup with nomad and consul. This will only work for x64 Linux machines, so for MacOS read the next section.


## Setting up nomad and consul without [cluster](https://github.com/liquidinvestigations/cluster)

Create a configuration file, `nomad-agent.hcl`, with the following content,
adapted to your machine in case `en0` is not the main network interface:

```hcl
advertise {
  http = "{{ GetInterfaceIP `en0` }}"
  serf = "{{ GetInterfaceIP `en0` }}"
}

client {
  enabled = true
  network_interface = "en0"
}
```

Increase `vm.max_map_count` to at least `262144`, to make elasticsearch happy -
see [the official documentation][] for details.

[the official documentation]: https://www.elastic.co/guide/en/elasticsearch/reference/current/docker.html#docker-cli-run-prod-mode

Make sure you have Python >= 3.7 installed.

```shell
consul agent -dev &
nomad agent -dev -config=nomad-agent.hcl &
```

## Setup

The Liquid Investigations cluster configuration is read from `liquid.ini`.
Start with the example configuration file:

```shell
cp examples/liquid.ini .
vim liquid.ini
```

We need a way to access Vault. The simplest way is to use:
```ini
[liquid]
domain = liquid.example.org
debug = true

vault_secrets = /opt/cluster/var/vault-secrets.ini

[collection:testdata]
workers = 1
```

This assumes the `vault-secrets.ini` file exists and contains a vault token. It
will be generated by the `./cluster.py autovault` command, or you can create it
manually in a different location with the following contents:

```ini
[vault]
root_token = s.Cmro41vNI4wIndgrPqzlqOKY
```

Then deploy to the cluster:

```shell
./liquid deploy
```

The liquid instance will listen by default on port 80 on the local machine. If
you don't have a DNS domain pointing to the macine, you can add entries to
`/etc/hosts`:

```
10.0.0.1 liquid.example.com
10.0.0.1 hoover.liquid.example.com
...
```

## Hoover
Set up `hoover-search`:

```shell
mkdir -p volumes/hoover/es/data
./liquid shell hoover-search ./manage.py migrate
./liquid shell liquid-core ./manage.py createsuperuser
```

### Testdata
Set up the `testdata` collection. First download the data:

```shell
mkdir -p collections
git clone https://github.com/hoover/testdata collections/testdata
```

Next define the collection in `liquid.ini`:

```ini
[collection:testdata]
workers = 1
```

Then redeploy liquid, run migrations, and tell `hoover-search` about the new
collection:

```shell
./liquid deploy
# ... wait for the containers to spin up
./liquid initcollection testdata
```

### Debugging
Set the debug flag in `liquid.ini`:
```ini
[liquid]
debug = on
```

Then redeploy (`./liquid deploy`).

To log into the snoop docker container for testdata:
```shell
./liquid shell snoop-testdata-api
```

To dump the nginx configuration:
```shell
nomad alloc fs $(./liquid alloc liquid nginx) nginx/local/core.conf
```

### Vagrant (out of date)

__Warning__: Scripts are out of date. These need to be updated to use [cluster](https://github.com/liquidinvestigations/cluster) inside the virtual machine.

You can run a full Liquid cluster in a local virtual machine using [Vagrant][].
The configuration has been tested with the [libvirt driver][] but should work
with the default VirtualBox driver as well.

After [installing vagrant][], run `vagrant up` to download, start and provision
the VM. It will expose port `80` as `1380` (the main website) and `4646` as
`14646` (Nomad's UI, useful for debugging). Then, log into the VM and deploy
some containers:

```shell
cat > liquid.ini <<EOF
[liquid]
domain = liquid.example.org
EOF

vagrant up
vagrant ssh # opens a shell inside the VM
```

Then, inside the VM:
```shell
cd /vagrant
./liquid deploy
```

[Vagrant]: https://www.vagrantup.com
[libvirt driver]: https://github.com/vagrant-libvirt/vagrant-libvirt
[installing vagrant]: https://www.vagrantup.com/docs/installation/


### Running custom jobs
You can deploy your own jobs on the cluster. First, create a nomad job file,
you can use one of the existing `.nomad` files as a starting point. Save it in
the `local` folder, or outside the repository, so that it doesn't interfere
with updates. Then add the job to `liquid.ini`:

```ini
[job:foo]
template = local/foo.nomad
```

Afterwards, run `./liquid deploy`, which will send your job `foo` to nomad.


### Working on components

In order to work on Hoover Search, Hoover Snoop, or Liquid Core, first clone the repositories:
```shell
cd repos
./clone.sh https  # or ./clone.sh ssh, based on preference
```

After that, set this flag in your configuration:

```ini
[liquid]
...
mount_local_repos = true
```

