#!/bin/bash -ex

#cd /opt/node
cd "$(dirname ${BASH_SOURCE[0]})/../.."

echo "Add some collections, check resources and deploy"
cp ci/conf/1-with-collections.ini liquid.ini

./liquid resources
./liquid deploy || ./liquid deploy

echo "Creating users..."
echo "$TEST_ADMIN_PASSWORD" | wc -c
./ci/ui/create_users.sh


function wait_testdata() {
  timeout 100 ./liquid dockerexec hoover:snoop ./manage.py rundispatcher || true

  until ./liquid dockerexec hoover:snoop ./manage.py workisdone testdata 2>/dev/null 1>/dev/null; do
    echo '---------------------------------------------------------------'
    curl http://10.66.60.1:9990/snoop/collections/testdata/json 2>/dev/null | jq .stats.progress_str
    uptime | awk -F'[a-z]:' '{ print $2}'
    free -h
    sleep 30
  done
}


set +x
echo "Waiting for processing to finish..."
wait_testdata

echo "Retrying errors..."
timeout 100 ./liquid dockerexec hoover:snoop ./manage.py retrytasks testdata --status error || true
timeout 100 ./liquid dockerexec hoover:snoop ./manage.py retrytasks testdata --status broken || true
wait_testdata
echo "All documents processed."

set -x
echo "Run UI test suite..."
(cd ./ci/ui/ && ./run_ui_tests.sh) || (echo "Sleeping for 10min because integration UI tests failed!" && sleep 600)
