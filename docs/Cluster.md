# Install a Cluster

Liquid Node requires a Nomad + Consul + Vault cluster where the software will
be deployed. There are a few options:

* [Install the Liquid Cluster](#install-the-liquid-cluster) - automated
  single-machine cluster, read the instructions before using in production
* [Install a Cluster Manually](#install-a-cluster-manually) - for production or
  barebones development setups
* [Use Vagrant](./Vagrant.md) - run `vagrant up` and be happy


Whichever option you choose, you will also need to:

* Increase `vm.max_map_count` to at least `262144`, to make elasticsearch
  happy - see the docs about [elasticsearch in docker][] for details.
* Make sure you have Python >= 3.7 installed.
* [Configure Nomad meta values](#nomad-configuration).

[elasticsearch in docker]: https://www.elastic.co/guide/en/elasticsearch/reference/current/docker.html#docker-cli-run-prod-mode


## Install the Liquid Cluster

[liquidinvestigations/cluster][cluster] is a self-configuring cluster of
Consul + Vault + Nomad. It's optimised for local development, testing, and
demo/staging servers. Add the following to `cluster.ini`, assuming the `node`
repo was cloned in `/opt/node`:

```ini
[nomad_meta]

# set on the one node that will listen on 80 and 443
liquid_ingress = true

# the path on the host that will mount volumes
liquid_volumes = /opt/node/volumes

# the path on the host that points to the original collections
liquid_collections = /opt/node/collections
```

[cluster]: https://github.com/liquidinvestigations/cluster


## Install a Cluster Manually

Download Consul, Vault and Nomad. For production environments follow their
manuals. For development run them all in `-dev` mode:

```shell
./consul agent -dev &
./vault agent -dev &
./nomad agent -dev &
```


## Nomad configuration

The following Nomad Meta values need to be set:

- `liquid_ingress = true` -- set on the one node that will listen on 80 and 443
- `liquid_volumes = /path/to/volumes` -- the path on the host that will mount
  volumes
- `liquid_collections = /path/to/collections` -- the path on the host that
  points to the original collections

The job constraints are set up in such a way that one single node will need to
have both flags set.

The `./liquid *` commands require both paths mentioned above to function. Take
care to set `[liquid] volumes` and `[liquid] collections` in `liquid.ini` to
the same paths as `liquid_volumes` and `liquid_collections`.


## Vault token

The liquid deployment script needs a Vault token to configure secrets for the
apps. It will read the token from an ini file which can be configured in
`liquid.ini`.

```ini
[cluster]
vault_secrets = ../cluster/var/vault-secrets.ini
```

The default assumes a Liquid Cluster is installed and running in a folder
adjacent to the node directory. `vault-secrets.ini` will be generated by the
`./cluster.py autovault` command. Otherwise, you can create it manually in a
different location, with the following contents:

```ini
[vault]
root_token = s.Cmro41vNI4wIndgrPqzlqOKY
```
